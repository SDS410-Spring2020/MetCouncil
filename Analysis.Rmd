---
title: "Analysis"
author: "Bouzaher, Julia"
date: "March 9, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(dplyr)
library(ggplot2)
library(sf)
library(sp)
library(raster)
library(dplyr)
library(rgdal)
library(rgeos)
library(readr)
#investigate ArcMap: library(arcmap)

landuse_filtered <- data.table::fread("data/derived/Export_Output.txt")
landuse <- read_sf(dsn = "data/source", layer = "GeneralizedLandUse2016")
landcover <- raster::raster("data/source/landcover/tcma_lc_finalv1.tif", RAT = TRUE) #Julias load
#landcover <- raster::raster("/Users/serenelee/Capstone/TCMA_ClassNames_Updated/tcma_lc_finalv1.tif")#Serene
#12 columns would be landcover

plot(landcover, axes = TRUE)

options(stringsAsFactors=FALSE)

#filtering the raster while still in raster format
#R package for Arcmap that can filter raster?
class(landcover@data)
data <- landcover@data


#Jessica might try on desktop computer to directly get dataframe:
#rasterdata <- raster::as.data.frame(landcover)


#trying to crop file
#somethingtocheck bounds(landcover)
#(xmin, xmax, ymin, ymax)
#490,000... 520,000,...521,000
extent(landcover)
e <- as(extent(460000, 465000, 4980000, 4990000), 'SpatialPolygons')
crs(landcover)
crs(e) <- "+proj=utm +zone=15 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
crs(e)
cropped2 <- raster::crop(landcover,e)
plot(cropped2, axes = TRUE)

## transforming to dataframe
#df <- raster::rasterToPoints(cropped2)
#df <- as.data.frame(df)

#transforming to dataframe directly
df2 <- raster::as.data.frame(cropped2, xy = TRUE)

#checking that the third column values are 1-11
min(df2$tcma_lc_finalv1)
max(df2$tcma_lc_finalv1)

# df2 <- df2 %>%
#   dplyr::rename(classid = tcma_lc_finalv1) %>%
#   mutate(classname = 0)
#   ifelse()

df2$tcma_lc_finalv1 <- as.character(df2$tcma_lc_finalv1)

df2 <- df2 %>%
  mutate(Type = recode(tcma_lc_finalv1,
                       "1" = "Grass/Shrub",
                       "2" = "Bare Soil",
                       "3" = "Buildings",
                       "4" = "Roads/Paved Surfaces",
                       "5" = "Lakes/Ponds",
                       "6" = "Deciduous Tree Canopy",
                       "7" = "Coniferous Tree Canopy",
                       "8" = "Agriculture",
                       "9" = "Emergent Wetland",
                       "10" = "Forested/Shrub Wetland",
                       "11" = "River",
                       "12" = "Extraction"))

df2 <- df2 %>%
  rename(TypeId = tcma_lc_finalv1)

# step5: x/y to find acreage
# x = 
# y = 
# 
# #Flowchart Step 5: Estimate percent forested areas within green areas filtered in Step 2
# 
# landuse <- as.data.frame(landuse)
# x <- unique(landuse$LUSE_DESC)
# x

#landuse <- landuse %>%
 # filter(LUSE_DESC == "Park, Recreational, or Preserve" | LUSE_DESC == "Undeveloped") %>%
  #st_as_sf()


#generating intersection in R
#uses too much memory
#landcoverp <- raster::rasterToPolygons(cropped2)
#trying to get compatible formats: landuse <- as.raster(landuse)

#rgeos::gIntersection(cropped2,landuse)

#projection(landuse) <- projection(cropped2)

#intersect <- raster::intersect(landuse, cropped2)




###----------------------------------- not currently in use
#alternate method
# library(foreign)
# rat <- foreign::read.dbf("data/source/landcover/tcma_lc_finalv1.vat.dbf")

# 
# #trying to split file
# library(SpaDES)
# #needs to be edited - will crash computer and fill up C:: drive
# o <- SpaDES.tools::splitRaster(landcover,
#   nx = 3,
#   ny = 3,
#  # buffer = c(0.5, 0.5),
#   path = "~data/source/landcover",
#   rType = "FLT4S")
```  

Some sanity checks of the data
```{r}
final_counts <- read_csv("final_counts_fixed.csv") %>% 
  mutate(miles = num*0.0000003861, landcover = case_when(
    is.na(landcover) ~ "NA",
    TRUE ~ landcover)
  )

nas <- final_counts %>% 
  filter(id == 0)

#get total area excluding nas
(sum(final_counts$miles) - nas$miles)
#area of seven county area 2976.97, as compared to this calculation of 2889.938
#however, census data from 2000, so is likely somewhat out-of-date

water <- final_counts %>% 
  filter(landcover %in% c("Lakes/Ponds", "River"))

sum(water$miles)
#204.9 m2 as opposed to expected 165.98 from census

final_counts$landcover <- factor(final_counts$landcover, levels = rev(c("NA", "Grass/Shrub", "Bare Soil", "Buildings", "Roads/Paved Surfaces", "Lakes/Ponds", "Deciduous Tree Canopy", "Coniferous Tree Canopy", "Agriculture", "Emergent Wetland", "Forested/Shrub Wetland", "River", "Extraction")))

ggplot(final_counts, aes(x = landcover, y = miles, fill = landcover)) + geom_col() + 
  coord_flip() +
  labs(x = NULL, y = "Square Miles", title = "Areas of land cover types from Raster") +
  theme_minimal(base_size = 14)+
  theme(legend.position = "none") +
  scale_fill_manual(values = rev(c("#000000", "#baed67", "#800000", "#ff0000", "#868686", "#456def", "#40bf00", "#1f8a1f", "#ffc124", "#63b4d5", "#bad8ec", "#009cff", "#a01ff1")))
```



```{r}
#Flowchart Step 6: Estimate percent forested areas within green land use filtered in Step 2


```